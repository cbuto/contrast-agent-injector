# Contrast Agent Injector

Contrast Agent Injector is a [Mutating Admission Webhook](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#mutatingadmissionwebhook) that will inject a Contrast Agent to a Kubernetes Pods to instrument the service running in the first container in the pod. 


## Supported Languages

* Java

## Getting Started

1. Add the `contrast-agent-injector: enabled` label to the namespace that your services are running in (only Pods created in this namespace will have the specified agent injected)

2. Add the required annotations to a Pod (`latest` can be used for the agent version). See the [examples](./examples/) folder.
```
contrast-agent-injector/version: <agent version>
contrast-agent-injector/language: java
contrast-agent-injector/enabled: <true|enabled>
```

3. Add the optional annotation (`contrast-agent-injector/config`) to the Pod in order to configure the agent further (See the [Agent Configuration](#agent-configuration) section for details)

### Agent Configuration

In order to add additional configuration to the Pods that are annotated for injection, the `contrast-agent-injector/config` annotation accepts a comma separated list of key value pairs to inject as environment variables into the Pod. Find the configuration values supported for each agent [here](https://docs.contrastsecurity.com/en/agents.html)

#### Example

```
annotations:
    ...
    contrast-agent-injector/config: CONTRAST__SERVER__ENVIRONMENT=qa, CONTRAST__SERVER__NAME=webgoat-k8s
    ...
```
## Helm Install

By default, the webhook will use a certificate generated by [kube-webhook-certgen](https://github.com/jet/kube-webhook-certgen) for TLS.

1. Create a Kubernetes Secret from a `contrast_security.yaml` file containing the required API keys

```
api:
  url: https://app.contrastsecurity.com/Contrast
  user_name: contrast_user
  api_key: demo
  service_key: demo
```

```
kubectl create secret generic contrast-agent-secret --from-file contrast_security.yaml
```

2. Update `contrast.secretName` in the [values file](./charts/contrast-agent-injector/values.yaml) to the name of the Secret you created previously (or leave the default)

3. Install the Helm chart (The chart isn't hosted in a Helm repo as of right now, so you'll need to clone this repo)
```
helm upgrade --install injector .
```

## Current Limitations

* Only supports injecting the agent into the first container in a Pod
* Only supports agent configuration via environment variables using the `contrast-agent-injector/config` annotation